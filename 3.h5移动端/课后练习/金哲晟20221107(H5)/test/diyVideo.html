<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>video</title>
  <style>
    @font-face {
      font-family: "iconfont";
      src: url('fonts/iconfont.eot?t=1600426546624');
      /* IE9 */
      src: url('fonts/iconfont.eot?t=1600426546624#iefix') format('embedded-opentype'),
        /* IE6-IE8 */
        url('data:application/x-font-woff2;charset=utf-8;base64,d09GMgABAAAAAAS4AAsAAAAACZwAAARrAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAHEIGVgCDSAqGEIUYATYCJAMYCw4ABCAFhG0HWBtOCFGULspqsq+wKWO+GKJwXogXwkCjQQ+Evn05o/Tmdn/CWtgG7CKF5wDBE+3X3uzO7ldJh0qDrg1PXronIomYrETRBCXeT3b2b3lEpbkvLFIehM2H9pLZzSaenZwqqfxQaVQqGrOyuvDwtnv/7k9So5BJKoGZTRUuRKGkK0x2QTiRPI44CCLOEosr0+0G0l/4RJO7B8EAIYJA47YGzrlqkEjLIJhA8XigAzpJpmAVUP1xr+qf5x8s61myQaI496BcKFwuUIHGXmQtSLmCWgewTbzfuh4CYqPWYKb61l6Ip/TdBMhpmTrEJ+y0ghKhyRccm8gHgrDcszcAePB+Xn5wJB4MV9FvdLjVuaGyp3ePG401m+oojA7nBdiTwIJlgELeQv8FLsgv48TyX+BtA1IhQ/tqFrOS69292J+EWg+L1PiXB46lDIEMQJ9S5K7OHaDCkkeGYlixMFTCisJwDGwY/N9TXpbZD9gzAPwBiGwk6QcOfgcvpWOqmuni+nDbJCffPri99vX5c4JDgObuNOtT9Qobn1udt1pvXyqbSOFmnLnrUp1xT05in3ORNC6+nT8KbDu2cILh7o5rl+7K1J35e9b7WiHOI4LWDRwQhtIW7srqIIzWBM4jQrddyno3JkG8WNmroq/UENHQrkXGZmh3yKq0M7oO1tmbuCt311QH7T+SszNH3zmavW3H1gfaO3fpCqqAIVBbk3Rl6+lFYfQpjxD/1LCiaKujjpQD+89yHz9y0JxlpFBTnnAd1a2FWEvuByU7/O7KqNeXCjfdL1cSSuJRmNo0Bpn8r4CxZCUHHcjbCN6cUle4Ls4hLHIutpit6Y6v6lp58hMru1btw3RqwOWJcnTx2zmdm0nVEhLUh2y1sY2ZRsiMJ91hePo8SkrtC2z+X28ZH25J8x/lc11WCMukL2WvGeIKj5MKnvzeVZWYhp/oVg54db9lpL7krXtXOz+MYaIn3rxmf0cKGU2aLN3uOQqu3RZ9sPmavnmV/5xqhowU6qgjOVx+IowrAqhXhNR4GWQA/BR+4datAgD7sL8Y/reDi/+X/Q6P6ylpaaV/QlEAPuYvOLy+4WiCbQB/FQONFf8pRcM5VVS6w6c02xpCgLf/sbIGxMYS/JPCtVdDBTsQeUXIKQBGYASs0DSq5DI4iVXwQmsQW9JwcqJBcCQjYNEUAaJ0BozcM1ilm6iSL8HpfQGvDAexo8g6Z2I2VmINwTrFbtQ/jCxXKGiYLprot3ZjM+rXSVzl0TRMbCuFVElJlxpwEJMhDrAHTAelBjJIKIDqiZthvz+EwiTkxS4qeSgNF8uyUfRFkisUgERbCExHYW5Iv2GIxSUkyHBWphIz398NM0X56UjFTFlUgxE2a+2ISqI0QBv0wUYzl/IS2wCTA0UZEAMREoDUE17Mb+RDkHDxVl6YCyXxdMiGFZPJRUZTvTS9MXCXVwEx/aN8GLGi4sRLgLv1qI3jhqJBT1QPxg9bQb+lB834SGLzsBU0xU6/PowJAAA=') format('woff2'),
        url('fonts/iconfont.woff?t=1600426546624') format('woff'),
        url('fonts/iconfont.ttf?t=1600426546624') format('truetype'),
        /* chrome, firefox, opera, Safari, Android, iOS 4.2+ */
        url('fonts/iconfont.svg?t=1600426546624#iconfont') format('svg');
      /* iOS 4.1- */
    }

    .iconfont {
      font-family: "iconfont" !important;
      font-size: 32px;
      color: #ccc;
      font-style: normal;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      cursor: pointer;
    }

    .icon-pause:before {
      content: "\e7d2";
    }

    .icon-loop:before {
      content: "\e6a9";
    }

    .icon-volume:before {
      content: "\e63a";
    }

    .icon-fullscreen:before {
      content: "\e640";
    }

    .icon-player:before {
      content: "\e62b";
    }

    div {
      box-sizing: border-box;
    }

    video {
      display: block;
      width: 100%;
      max-height: 100%;
    }

    .player {
      position: relative;
      display: flex;
      flex-direction: column;
      justify-content: center;
      width: 638px;
      height: 493px;
      margin: 100px auto;
      background-color: #000;
    }

    .player .hint {
      position: absolute;
      top: 0;
      width: 100%;
      height: 30px;
      color: #fff;
      text-align: center;
      line-height: 30px;
      font-size: 20px;
      letter-spacing: .2em;
    }

    .player-screen {
      position: absolute;
      width: 100%;
      height: 100%;
      top: 0;
      left: 0;
      display: flex;
      justify-content: center;
    }


    .player-controls {

      display: flex;
      flex-direction: column;
      justify-content: space-between;
      align-items: center;
      position: absolute;
      bottom: 0;
      width: 100%;
      height: 60px;
    }


    .player-progress {
      width: 100%;
      height: 2px;
      background-color: #ccc;
    }

    .player-progress:hover .progress-inline {
      display: block;
    }

    .player-progress .progress-inline {
      position: relative;
      display: none;
      width: 0%;
      height: 2px;
      background-color: rgb(18, 177, 226);
    }

    .player-progress .progress-unit {
      position: absolute;
      right: -10px;
      top: 0;
      bottom: 0;
      width: 10px;
      height: 10px;
      margin: auto;
      background-color: rgb(18, 177, 226);
      border-radius: 50%;
    }

    .player-time {
      position: absolute;
      right: 0;
      top: -40px;
      color: #fff;
      user-select: none;
    }

    .player-controls .player-operator {
      display: flex;
      justify-content: space-between;
      align-items: center;
      width: 100%;
      padding: 4px 20px;
    }

    .operator-right {
      display: flex;
      align-items: center;
    }

    .operator-right i {
      padding: 0 4px;
    }

    .active {
      color: aqua;
    }

    span {
      user-select: none;
    }
  </style>
  <script src="./my.js"></script>
</head>

<body>
  <div id="my-player" class="player">
    <p class="hint">暂未播放影片</p>
    <div class="player-screen">
      <video src="video/mp4.mp4">
        <source src="video/mp4.mp4" type="video/mp4">
      </video>
    </div>

    <div class="player-controls">
      <div class="player-progress">
        <p class="player-time"><span class="player-current">00:00:00</span> / <span class="player-count">00:00:00</span>
        </p>
        <div class="progress-inline">
          <div class="progress-unit"></div>
        </div>
      </div>
      <div class="player-operator">
        <i id="contr-play" class="iconfont icon-player icon-pause"></i>
        <div class="operator-right">
          <input type="range" value="10">
          <i id="contr-volume" class=" iconfont icon-volume"></i>
          <i id="contr-loop" class=" iconfont icon-loop"></i>
          <i id="contr-full" class=" iconfont icon-fullscreen"></i>
        </div>
      </div>
    </div>
  </div>
</body>
<script src="./my.js"></script>
<script src="./Storage.js"></script>
<script>
  let storage = new Storage();
  // let allTime = $("video").duration;
  let _isPaused = true;
  let _volume = .1;
  class MyVideo {
    static totalWidth = $(".player-progress").offsetWidth;
    constructor() {
      this.player = $("video");
      this.isPaused;
      this.volume;
      this.$ele = {
        $currentTime: $(".player-current"),
        $allTime: $(".player-count"),
        $progress: $(".progress-inline"),
        $unit: $(".progress-unit"),
        $goOrStop: $("#contr-play"),
        $loop: $("#contr-loop"),
        $fullScreen: $("#contr-full"),
        $volumner: $("#contr-volume"),
        $myplayer: $("#my-player"),
      };

      this.init();
    }
    set isPaused(value) {
      _isPaused = value;
      // console.log(value, "监测Paused set");
      _isPaused ? $("#contr-play").classList.add("icon-player") : $("#contr-play").classList.remove("icon-player");
      _isPaused ? this.stop() : this.play();
    }
    get isPaused() {
      // console.log("监测Paused get");
      return _isPaused;
    }
    set volume(value) {
      _volume = value;
      this.setVolume(_volume);
    }
    setVolume(num) {
      this.player.volume = num;
    }
    get volume() {
      return _volume;
    }
    init() {
      this.volume = _volume;
      this.proInfo = {
        width: 0,
        startX: 0,
        isDown: false
      }
      //当页面关闭时,存储当前视频src和播放时间
      this.eventListen();
      this.backToExit();
    }
    backToExit () {
      let num = storage.getStorage(this.player.src)
      if (!num) {
        return false;
      }
      this.setProgress(num);
      this.player.currentTime = num;
      
    }
    eventListen() {
      document.addEventListener("visibilitychange", (e) => {
        if (document.visibilityState === "hidden") {
          if (this.player.currentTime) {
            storage.setStorage(this.player.src, this.player.currentTime);
          }
        }
      })
      //调节音量绑定
      $("input").addEventListener("change", (e) => {
        console.log(e.target.value);
        this.volume = e.target.value / 100;
      })
      //是否全屏
      this.$ele.$fullScreen.addEventListener("click", (e) => {
        if (isFullScreen()) {
          closeFullScreen(this.$ele.$myplayer);
          this.$ele.$fullScreen.classList.remove("active");
        } else {
          openFullScreen(this.$ele.$myplayer);
          this.$ele.$fullScreen.classList.add("active");
        }
      })
      //是否循环绑定
      this.$ele.$loop.addEventListener("click", (e) => {
        // console.log(this.player.loop);
        this.player.loop = !this.player.loop;
        $("#contr-loop").classList.toggle("active");
      })
      //播放暂停
      this.$ele.$goOrStop.addEventListener("click", (e) => {
        this.isPaused = !_isPaused;
      }, false)
      //进度条跟随
      this.player.addEventListener("timeupdate", (e) => {
        // console.log(this.player.currentTime); //当前时间
        //设置进度条滚动
        this.setProgress(this.player.currentTime);
        //设置当前时间/总时间
        this.setTimeRatio();
      })
      //拖动进度条
      document.addEventListener("mousedown", drag);
      // this.$ele.$unit.addEventListener("mousedown", drag);
      document.addEventListener("mousemove", drag);
      document.addEventListener("mouseup", drag);
    }
    play() {
      this.player.play();
    }
    stop() {
      this.player.pause();
    }
    setProgress(time) {
      let ratio = (time / $("video").duration);
      this.$ele.$progress.style.width = (ratio * 100) + "%";
    }
    setTimeRatio() {
      let allTime = formatTime($("video").duration);
      let currentTime = formatTime($("video").currentTime);
      this.$ele.$currentTime.innerText = currentTime;
      this.$ele.$allTime.innerText = allTime;
    }
  }
  function formatTime(time) {
    let h = ~~(time / 3600);
    time = time - h * 3600;
    let m = ~~(time / 60);
    time = time - m * 60;
    let s = ~~time;
    h = padLeft(h);
    m = padLeft(m);
    s = padLeft(s);
    return `${h}:${m}:${s}`;
  }
  function padLeft(num) {
    return String(num)[1] ? String(num) : "0" + num;
  }
  let myVideo = new MyVideo();
  function drag(e) {
    methodMap[e.type](e);
  }
  let methodMap = {
    mousedown: function (e) {
      // console.log(e.target.className);
      if (e.target.className === "progress-unit") {
        myVideo.isPaused = true;
        myVideo.proInfo.isDown = true;
        myVideo.proInfo.startX = e.clientX;
        // console.log("鼠标按下存储 当前鼠标位置" + myVideo.proInfo.startX);
        // console.log("鼠标按下 存储进度条当前长度", $(".progress-inline").offsetWidth);
        myVideo.proInfo.width = $(".progress-inline").offsetWidth;
      } else {
        if (/progress/g.test(e.target.className)) {
          //直接跳转到当前位置
          let currX = e.clientX;
          let _x = currX - getPosition($(".progress-inline")).left;
          let ratio = _x / MyVideo.totalWidth;
          $(".progress-inline").style.width = ratio + "%";
          $("video").currentTime = ~~(ratio * ($("video").duration));
        }
      }
    },
    mousemove: function (e) {

      if (myVideo.proInfo.isDown) {
        $(".progress-inline").style.display = "block";
        let currentX = e.clientX;
        let diff_x = currentX - myVideo.proInfo.startX;
        // console.log(diff_x, "记录拖动的距离");
        let finalX = myVideo.proInfo.width + diff_x;
        let ratio = finalX / MyVideo.totalWidth;
        // console.log(finalX, "最终位置");
        // console.log(ratio, "比例");
        // console.log(~~(ratio * ($("video").dutation)), "最后时间");
        $(".progress-inline").style.width = finalX + "px";
        $("video").currentTime = ~~(ratio * ($("video").duration));

      }
    },
    mouseup: function (e) {
      if (/progress/g.test(e.target.className)) {
        // console.log(e.target);
        myVideo.isPaused = false;
        myVideo.proInfo.isDown = false;
      }
    }
  }
</script>

</html>